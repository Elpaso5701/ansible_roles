- name: Install and configure Apache and PostgreSQL servers
  hosts: server:db
  become: yes
  vars:
    db_host: "{{ db.some.net }}"
    db_name: "{{ app_db }}"
    db_user: "{{ app_user }}"
    db_pass: "{{ app_pass }}"
  roles:
    - role: server
    - role: db

#     - name: Install PostgreSQL client library
#   apt:
#     name: libpq-dev
#     state: present

# - name: Install PostgreSQL server
#   apt:
#     name: postgresql
#     state: present

# - name: Ensure PostgreSQL service is running and enabled
#   service:
#     name: postgresql
#     state: started
#     enabled: yes

# - name: Create PostgreSQL database
#   postgresql_db:
#     name: "{{ db_name }}"
#     state: present
#     login_user: postgres
#     login_password: ""
#     login_host: "{{ db_host }}"
#     login_unix_socket: /var/run/postgresql

# - name: Create PostgreSQL user
#   postgresql_user:
#     name: "{{ db_user }}"
#     password: "{{ db_pass }}"
#     login_user: postgres
#     login_password: ""
#     login_host: "{{ db_host }}"
#     login_unix_socket: /var/run/postgresql
# Role: server/tasks/main.yml

# yaml
# Copy code
# ---
# - name: Update apt cache and install Apache web server
#   apt:
#     name: "{{ item }}"
#     state: present
#   loop:
#     - apache2
#     - libapache2-mod-php
#     - php
#     - php-mysql
#     - php-curl
#     - php-json
#     - php-mbstring
#     - nodejs
#     - npm

- name: Install Composer
  shell: >
    curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer
  args:
    executable: /bin/bash

- name: Clone Laravel repository and configure environment
  block:
    - name: Git clone Laravel
      git:
        repo: "https://github.com/Practical-DevOps/app-for-devops.git"
        dest: "/var/www/html/app-for-devops"
        clone: yes

    - name: Rename .env.example to .env
      command: mv /var/www/html/app-for-devops/.env.example /var/www/html/app-for-devops/.env

    - name: Update .env file with database credentials
      ansible.builtin.blockinfile:
        path: /var/www/html/app-for-devops/.env
        block: |
          DB_HOST={{ db_host }}
          DB_DATABASE={{ db_name }}
          DB_USERNAME={{ db_user }}
          DB_PASSWORD={{ db_pass }}
        marker: "# {mark} Ansible managed block"
        create: yes

    - name: Change ownership of Laravel app directory
      ansible.builtin.file:
        path: /var/www/html/app-for-devops
        owner: www-data
        group: www-data
        recurse: yes

    - name: Composer install
      command: composer install
      args:
        chdir: /var/www/html/app-for-devops
